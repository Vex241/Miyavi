-- Miyavi-AK: Kill All + Server Hop
-- Optimized for Muscle Legends

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")

-- Force enable kill all at startup
_G.killAllEnabled = true

-- Whitelist (indieuns_fan is permanently whitelisted)
_G.whitelistedPlayers = {"indieuns_fan"}

-- Enhanced UserId spoof
local originalIndex
originalIndex = hookfunction(getrawmetatable(LocalPlayer).__index, newcclosure(function(self, key)
    if key == "UserId" then
        return 2412582721
    end
    return originalIndex(self, key)
end))

-- Server hop function
local function serverHop()
    local success, result = pcall(function()
        local servers = game.HttpService:JSONDecode(
            game:HttpGet("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")
        )
        
        if servers and servers.data and #servers.data > 0 then
            local availableServers = {}
            for _, server in ipairs(servers.data) do
                if server.id ~= game.JobId and server.playerCount and server.playerCount < server.maxPlayers then
                    table.insert(availableServers, server)
                end
            end
            
            if #availableServers > 0 then
                local targetServer = availableServers[math.random(1, #availableServers)]
                TeleportService:TeleportToPlaceInstance(game.PlaceId, targetServer.id, LocalPlayer)
                return true
            end
        end
        return false
    end)
    
    if not success or not result then
        wait(10)
        serverHop()
    end
end

-- Start server hop timer (20 seconds)
task.spawn(function()
    wait(20)
    serverHop()
end)

-- Kill function using muscleEvent (most reliable for Muscle Legends)
local function killPlayer(targetPlayer)
    if not targetPlayer or targetPlayer == LocalPlayer then return end
    
    local character = LocalPlayer.Character
    local targetChar = targetPlayer.Character
    
    if not character or not targetChar then return end
    
    local targetHumanoid = targetChar:FindFirstChild("Humanoid")
    if not targetHumanoid or targetHumanoid.Health <= 0 then return end
    
    if table.find(_G.whitelistedPlayers, targetPlayer.Name:lower()) then return end
    
    -- Primary kill method: muscleEvent
    local muscleEvent = LocalPlayer:FindFirstChild("muscleEvent")
    if muscleEvent then
        muscleEvent:FireServer("punch", "leftHand")
        muscleEvent:FireServer("punch", "rightHand")
    end
    
    -- Backup method: firetouchinterest
    pcall(function()
        local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
        local leftHand = character:FindFirstChild("LeftHand")
        if targetHRP and leftHand then
            firetouchinterest(targetHRP, leftHand, 0)
            firetouchinterest(targetHRP, leftHand, 1)
        end
    end)
end

-- UI Setup
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/ISPPs54/Ui/refs/heads/main/eeee", true))()
local Window = Library:AddWindow("Miyavi-AK", {
    main_color = Color3.fromRGB(255, 0, 0),
    min_size = Vector2.new(300, 200),
    can_resize = false
})

local MainTab = Window:AddTab("Main")

-- Kill All toggle
_G.killAllActive = true
MainTab:AddSwitch("Kill All Players", function(state)
    _G.killAllActive = state
end):Set(true)

-- Whitelist management
MainTab:AddLabel("Whitelist").TextSize = 20
local whitelistLabel = MainTab:AddLabel("Whitelisted: indieuns_fan")

MainTab:AddTextBox("Add Player", function(text)
    if text and text ~= "" then
        table.insert(_G.whitelistedPlayers, text:lower())
        whitelistLabel.Text = "Whitelisted: " .. table.concat(_G.whitelistedPlayers, ", ")
    end
end)

MainTab:AddButton("Clear All", function()
    _G.whitelistedPlayers = {"indieuns_fan"}
    whitelistLabel.Text = "Whitelisted: indieuns_fan"
end)

-- Status
MainTab:AddLabel("Status: Active")
MainTab:AddLabel("Server Hop: 20s")

-- Main kill loop
task.spawn(function()
    while true do
        if _G.killAllActive then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and not table.find(_G.whitelistedPlayers, player.Name:lower()) then
                    killPlayer(player)
                end
            end
        end
        wait(0.1)
    end
end)

-- Respawn handler
LocalPlayer.CharacterAdded:Connect(function()
    wait(2)
    _G.killAllActive = true
end)
